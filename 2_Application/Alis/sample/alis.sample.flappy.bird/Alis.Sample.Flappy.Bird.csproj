<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <TargetFramework>net9.0</TargetFramework>
        <OutputType>WinExe</OutputType>
        <OutDir>bin/$(Configuration)/$(RuntimeIdentifier)/lib/</OutDir>
        <LangVersion>13</LangVersion>
        <Nullable>disable</Nullable>
        <AllowUnsafeBlocks>false</AllowUnsafeBlocks>
        <SonarQubeExclude>true</SonarQubeExclude>
        <AssetsExternal>false</AssetsExternal>
    </PropertyGroup>

    <PropertyGroup>
        <DefineConstants>$(DefineConstants);$([System.String]::Copy('$(RuntimeIdentifier)').Replace('-',''));$([System.String]::Copy('$(NETCoreSdkRuntimeIdentifier)').Replace('-',''));</DefineConstants>
    </PropertyGroup>

    <ItemGroup>
        <AssemblyAttribute Include="System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverageAttribute"/>
    </ItemGroup>

    <PropertyGroup>
        <NameTest>$([System.Text.RegularExpressions.Regex]::Replace('$(AssemblyName)', '.[^.]*Sample[^*]*', ''))</NameTest>
    </PropertyGroup>

    <ItemGroup>
        <ProjectReference
            Condition="Exists('$(ProjectDir)../src/$(NameTest).csproj') == True"
            Include="$(ProjectDir)../src/$(NameTest).csproj"/>

        <ProjectReference
            Condition="Exists('$(ProjectDir)../src/$(NameTest).csproj') == False"
            Include="$(ProjectDir)../../src/$(NameTest).csproj"/>

        <ProjectReference
            Condition="Exists('$(ProjectDir)../generator/$(NameTest).Generator.csproj')"
            Include="$(ProjectDir)../generator/$(NameTest).Generator.csproj"
            OutputItemType="Analyzer"
            PrivateAssets="all"
            ReferenceOutputAssembly="false"/>
    </ItemGroup>

    <ItemGroup>
        <ProjectReference Condition="$(ProjectDir.Contains('1_Presentation')) OR $(ProjectDir.Contains('2_Application'))"
                          Include="
          $(SolutionDir)4_Operation/**/**/generator/**/*Generator.csproj;
          $(SolutionDir)6_Ideation/**/**/generator/**/*Generator.csproj;"
                          OutputItemType="Analyzer"
                          PrivateAssets="all"
                          ReferenceOutputAssembly="false"/>
    </ItemGroup>

    <PropertyGroup Condition="'$(Configuration)'=='Release'">
        <!-- Enables Ahead-of-Time (AOT) compilation for maximum performance and smaller binaries. -->
        <PublishAot>true</PublishAot>
        <!-- Publishes all dependencies with the app, so it runs independently of the system's .NET installation. -->
        <SelfContained>true</SelfContained>

        <!-- Uses invariant globalization to reduce the size by excluding culture-specific data. -->
        <InvariantGlobalization>true</InvariantGlobalization>
        <!-- Folds identical method bodies to reduce code duplication and binary size. -->
        <IlcFoldIdenticalMethodBodies>true</IlcFoldIdenticalMethodBodies>
        <!-- Disables reflection support to allow more aggressive trimming and reduce binary size. -->
        <IlcDisableReflection>false</IlcDisableReflection>

        <!-- Disables stack trace support to save space, at the cost of less detailed error information. -->
        <StackTraceSupport>false</StackTraceSupport>
        <!-- Optimizes the build for size rather than speed. -->
        <OptimizationPreference>Size</OptimizationPreference>
        <!-- Removes debug information from the output, reducing binary size. -->
        <DebugType>none</DebugType>

        <!-- Generates a method statistics file for analysis; does not affect published size. -->
        <IlcGenerateMstatFile>true</IlcGenerateMstatFile>
        <!-- Generates a DGML graph file for code analysis; does not affect published size. -->
        <IlcGenerateDgmlFile>true</IlcGenerateDgmlFile>
        <!-- Generates a map file for code analysis; does not affect published size. -->
        <IlcGenerateMapFile>true</IlcGenerateMapFile>
        <!-- Dumps generated IL code for inspection; does not affect published size. -->
        <IlcDumpGeneratedIL>true</IlcDumpGeneratedIL>

        <!-- Enables tree trimming to remove unused code and libraries, reducing the final binary size. -->
        <PublishTrimmed>true</PublishTrimmed>
        <!-- Aggressively trims unused assemblies and types; 'link' is the most space-saving mode. -->
        <TrimMode>link</TrimMode>
        <!-- Suppresses warnings about code that may be unsafe to trim, useful for aggressive size reduction. -->
        <SuppressTrimAnalysisWarnings>true</SuppressTrimAnalysisWarnings>
        <!-- Compresses files in single-file publish mode, further reducing disk footprint. -->
        <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
        <!-- Removes debugging symbols from the output, saving space in the final binary. -->
        <StripSymbols>true</StripSymbols>
        <!-- Disables ReadyToRun compilation, which can increase binary size; only enable if startup performance is critical. -->
        <EnableReadyToRun>false</EnableReadyToRun>
        <!-- Ensures native libraries are extracted only when needed, reducing initial disk usage. -->
        <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
        <!-- Allows unloading of unused assemblies, which can help reduce memory and disk usage in some scenarios. -->
        <EnableAssemblyLoadContextUnload>true</EnableAssemblyLoadContextUnload>
        <!-- Prevents inclusion of default items (like unnecessary files) in the build output, reducing published size. -->
        <EnableDefaultItems>true</EnableDefaultItems>
        <!-- Avoids copying unused satellite assemblies (localization resources), saving space if not needed. -->
        <CopyUnusedSatelliteAssemblies>false</CopyUnusedSatelliteAssemblies>
        <!-- Disables generation of XML documentation files, which are not needed for runtime and take extra space. -->
        <GenerateDocumentationFile>false</GenerateDocumentationFile>
        <!-- Prevents creation of reference assemblies, which are only needed for development, not for deployment. -->
        <ProduceReferenceAssembly>false</ProduceReferenceAssembly>
        <!-- Disables SourceLink, which embeds source control metadata and can increase output size. -->
        <EnableSourceLink>false</EnableSourceLink>
        <!-- Prevents generation of native debug symbols (.dSYM) on macOS. -->
        <DebugSymbols>false</DebugSymbols>
    </PropertyGroup>

    
    <ItemGroup Condition="Exists('$(ProjectDir)Assets/') AND '$(AssetsExternal)' == 'true'">
        <None
        Update="$(ProjectDir)Assets/**"
        LinkBase="Assets"
        CopyToOutputDirectory="Always"
        CopyToPublishDirectory="Always"/>
    </ItemGroup>
    
    
    <ItemGroup Condition="Exists('$(ProjectDir)Assets/') AND '$(AssetsExternal)' == 'false'">
        <EmbeddedResource Include="Assets/**/*" Exclude="Assets/**/*.cs;Assets/**/*.md" />
    </ItemGroup>

</Project>