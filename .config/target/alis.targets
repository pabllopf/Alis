<Project>

    <PropertyGroup>
        <!-- Deriva el nombre del ensamblado a partir del archivo .targets -->
        <_PackageAssemblyName>$(MSBuildThisFileName)</_PackageAssemblyName>
        <_PackageAssemblyName>$([System.IO.Path]::GetFileNameWithoutExtension($(_PackageAssemblyName)))</_PackageAssemblyName>

        <!-- Si RuntimeIdentifier está vacío, usa NETCoreSdkRuntimeIdentifier -->
        <_EffectiveRuntimeIdentifier Condition="'$(RuntimeIdentifier)' != ''">$(RuntimeIdentifier)</_EffectiveRuntimeIdentifier>
        <_EffectiveRuntimeIdentifier Condition="'$(RuntimeIdentifier)' == '' and '$(NETCoreSdkRuntimeIdentifier)' != ''">$(NETCoreSdkRuntimeIdentifier)</_EffectiveRuntimeIdentifier>
    </PropertyGroup>

    <!-- Solo referencia si hay un RID efectivo -->
    <ItemGroup Condition="'$(_EffectiveRuntimeIdentifier)' != ''">
        <Reference Include="$(_PackageAssemblyName)">
            <HintPath>$(MSBuildThisFileDirectory)../runtimes/$(_EffectiveRuntimeIdentifier)/lib/$(TargetFramework)/$(_PackageAssemblyName).dll</HintPath>
            <Private>true</Private>
        </Reference>
    </ItemGroup>


    <!-- ========== PROPIEDADES DE ASSETS ========== -->
    <PropertyGroup>
        <!-- Carpeta de recursos -->
        <AssetsDir>$(ProjectDir)Assets</AssetsDir>

        <!-- Archivos generados intermedios -->
        <AssetsZip>$(ProjectDir)obj/assets.zip</AssetsZip>
        <AssetsOutput>$(ProjectDir)obj/assets.pack</AssetsOutput>
    </PropertyGroup>


    <!-- ========== TARGET PARA GENERAR EL ZIP ========== -->
    <Target Name="ZipAssets" BeforeTargets="BeforeBuild;BeforePublish" Condition="Exists('$(ProjectDir)')">

        <Message Text="ZipAssets: AssetsDir='$(AssetsDir)'; AssetsZip='$(AssetsZip)'; AssetsOutput='$(AssetsOutput)'" Importance="High"/>

        <!-- Windows -->
        <Exec Condition="Exists('$(AssetsDir)') AND '$(OS)' == 'Windows_NT'"
              Command="powershell -NoLogo -Command &quot;Compress-Archive -Path '$(AssetsDir)\\*' -DestinationPath '$(AssetsZip)' -Force; [Convert]::ToBase64String([System.IO.File]::ReadAllBytes('$(AssetsZip)')) | Out-File -FilePath '$(AssetsOutput)' -Encoding ASCII&quot;"/>

        <!-- macOS/Linux -->
        <Exec Condition="Exists('$(AssetsDir)') AND '$(OS)' != 'Windows_NT'"
              Command="sh -c &quot;zip -r -9 '$(AssetsZip)' '$(AssetsDir)' &amp;&amp; base64 &lt; '$(AssetsZip)' &gt; '$(AssetsOutput)'&quot;"/>

        <!-- Si no hay AssetsDir -->
        <Message Condition="!Exists('$(AssetsDir)')" Text="No existe el directorio '$(AssetsDir)'. Se genera '$(AssetsOutput)' vacío." Importance="High"/>

        <Exec Condition="!Exists('$(AssetsDir)') AND '$(OS)' == 'Windows_NT'"
              Command="powershell -NoLogo -Command &quot;Set-Content -Path '$(AssetsOutput)' -Value '' -Encoding ASCII&quot;"/>

        <Exec Condition="!Exists('$(AssetsDir)') AND '$(OS)' != 'Windows_NT'"
              Command="sh -c &quot;mkdir -p '$(ProjectDir)obj' &amp;&amp; : &gt; '$(AssetsOutput)'&quot;"/>

    </Target>


    <!-- ========== REGISTRO DEL OUTPUT ========== -->
    <ItemGroup>
        <AdditionalFiles Include="$(AssetsOutput)"
                         CopyToOutputDirectory="Never"
                         CopyToPublishDirectory="Never"
                         Visible="false"/>
    </ItemGroup>




    <Target Name="GenerateGitattributesForBrowserWasm" BeforeTargets="Build">
        <PropertyGroup>
            <IsBrowserWasm Condition="'$(RuntimeIdentifier)' == 'browser-wasm'">true</IsBrowserWasm>
            <IsBrowserWasm Condition="'$(RuntimeIdentifier)' != 'browser-wasm'">false</IsBrowserWasm>
        </PropertyGroup>

        <WriteLinesToFile
            Condition="'$(IsBrowserWasm)' == 'true'"
            File="$(MSBuildProjectDirectory)/.gitattributes"
            Lines="# put these in .gitattributes file
                *.js binary
                *.json binary
                *.css binary
                *.html binary"
            Overwrite="true" />

        <WriteLinesToFile
            Condition="'$(IsBrowserWasm)' == 'true'"
            File="$(MSBuildProjectDirectory)/.nojekyll"
            Lines=""
            Overwrite="true" />
        
        <WriteLinesToFile
            Condition="'$(IsBrowserWasm)' == 'true'"
            File="$(MSBuildProjectDirectory)/Native/emscripten.c"
            Lines='#include "emscripten.h"'
            Overwrite="true" />

        <WriteLinesToFile
            Condition="'$(IsBrowserWasm)' == 'true'"
            File="$(MSBuildProjectDirectory)/Native/libEGL.c"
            Lines='#include &lt;EGL/egl.h&gt;'
            Overwrite="true" />
        
        <WriteLinesToFile
            Condition="'$(IsBrowserWasm)' == 'true'"
            File="$(MSBuildProjectDirectory)/Native/openal32.c"
            Lines='
            #include &lt;AL/al.h&gt; 
            #include &lt;AL/alc.h&gt;'
            Overwrite="true" />
        
        <Delete Condition="'$(IsBrowserWasm)' == 'false'" Files="$(MSBuildProjectDirectory)/.gitattributes" />
        <Delete Condition="'$(IsBrowserWasm)' == 'false'" Files="$(MSBuildProjectDirectory)/.nojekyll" />

        <ItemGroup Condition="'$(IsBrowserWasm)' == 'true'">
            <None Include=".gitattributes" CopyToPublishDirectory="Always" CopyToOutputDirectory="Always" />
            <NativeFileReference Include="Native/libEGL.c" ScanForPInvokes="true" />
            <NativeFileReference Include="Native/openal32.c" ScanForPInvokes="true" />
            <NativeFileReference Include="Native/emscripten.c" ScanForPInvokes="true" />
        </ItemGroup>
    </Target>

</Project>
