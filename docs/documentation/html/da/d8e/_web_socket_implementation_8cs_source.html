<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ALIS: D:/a/Alis/Alis/4_Operation/Network/src/Internal/WebSocketImplementation.cs Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../customLayout.xml" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ALIS
   &#160;<span id="projectnumber">0.0.5</span>
   </div>
   <div id="projectbrief">Develop the video games of your dreams.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('da/d8e/_web_socket_implementation_8cs_source.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">WebSocketImplementation.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// --------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//                               █▀▀█ ░█─── ▀█▀ ░█▀▀▀█</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//                              ░█▄▄█ ░█─── ░█─ ─▀▀▀▄▄</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//                              ░█─░█ ░█▄▄█ ▄█▄ ░█▄▄▄█</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//  --------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//  File:WebSocketImplementation.cs</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//  Author:Pablo Perdomo Falcón</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//  Web:https://www.pabllopf.dev/</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">//  Copyright (c) 2021 GNU General Public License v3.0</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">//  This program is free software:you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">//  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">//  the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">//  (at your option) any later version.</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">//  This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">//  but WITHOUT ANY WARRANTY without even the implied warranty of</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">//  GNU General Public License for more details.</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">//  You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">//  along with this program.If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">//  --------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">using</span> System;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">using</span> System.IO;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">using</span> System.IO.Compression;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">using</span> System.Net.WebSockets;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">using</span> System.Runtime.CompilerServices;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">using</span> System.Text;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">using</span> System.Threading;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">using</span> System.Threading.Tasks;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#if RELEASESIGNED</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;[assembly: InternalsVisibleTo(<span class="stringliteral">&quot;Ninja.WebSockets.UnitTests, PublicKey=0024000004800000940000000602000000240000525341310004000001000100b1707056f4761b7846ed503642fcde97fc350c939f78026211304a56ba51e094c9cefde77fadce5b83c0a621c17f032c37c520b6d9ab2da8291a21472175d9caad55bf67bab4bffb46a96f864ea441cf695edc854296e02a44062245a4e09ccd9a77ef6146ecf941ce1d9da078add54bc2d4008decdac2fa2b388e17794ee6a6&quot;</span>)]</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;[assembly: InternalsVisibleTo(<span class="stringliteral">&quot;Ninja.WebSockets.UnitTests&quot;</span>)]</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160; </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">namespace </span><a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html">Alis.Core.Network.Internal</a></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html">   50</a></span>&#160;    <span class="keyword">internal</span> <span class="keyword">class </span><a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html">WebSocketImplementation</a> : WebSocket</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    {</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">   55</a></span>&#160;        <span class="keyword">private</span> readonly Guid <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a4515580f59eff64ada495876ee84a814">   60</a></span>&#160;        <span class="keyword">private</span> readonly <span class="keywordtype">bool</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a4515580f59eff64ada495876ee84a814">_includeExceptionInCloseResponse</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">   65</a></span>&#160;        <span class="keyword">private</span> readonly CancellationTokenSource <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">   70</a></span>&#160;        <span class="keyword">private</span> readonly <span class="keywordtype">bool</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a8f7ee9d53d72ace4dea95e4787259623">   75</a></span>&#160;        <span class="keyword">private</span> readonly <a class="code" href="../../de/df6/interface_alis_1_1_core_1_1_network_1_1_i_ping_pong_manager.html">IPingPongManager</a> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a8f7ee9d53d72ace4dea95e4787259623">_pingPongManager</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">   80</a></span>&#160;        <span class="keyword">private</span> readonly Func&lt;MemoryStream&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a130c0dd79df32564fbf4e8d175f7e62e">   85</a></span>&#160;        <span class="keyword">private</span> readonly SemaphoreSlim <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a130c0dd79df32564fbf4e8d175f7e62e">_semaphore</a> = <span class="keyword">new</span> SemaphoreSlim(1);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">   90</a></span>&#160;        <span class="keyword">private</span> readonly Stream <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5f8d53537efa6b9c79df94fa84d8b3be">   95</a></span>&#160;        <span class="keyword">private</span> readonly <span class="keywordtype">bool</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5f8d53537efa6b9c79df94fa84d8b3be">_usePerMessageDeflate</a>;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a1aa5bf101aa734ccb4184b035a969f2e">  100</a></span>&#160;        <span class="keyword">private</span> WebSocketCloseStatus? <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a1aa5bf101aa734ccb4184b035a969f2e">_closeStatus</a>;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a33dc3b680b093f0aba60f92861d993a4">  105</a></span>&#160;        <span class="keyword">private</span> <span class="keywordtype">string</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a33dc3b680b093f0aba60f92861d993a4">_closeStatusDescription</a>;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">  110</a></span>&#160;        <span class="keyword">private</span> WebSocketMessageType <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">_continuationFrameMessageType</a> = WebSocketMessageType.Binary;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#afab6be1a75087a1817471656cfb1023f">  115</a></span>&#160;        <span class="keyword">private</span> <span class="keywordtype">bool</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#afab6be1a75087a1817471656cfb1023f">_isContinuationFrame</a>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">  120</a></span>&#160;        <span class="keyword">private</span> <a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html">WebSocketReadCursor</a> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00125"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">  125</a></span>&#160;        <span class="keyword">private</span> WebSocketState <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00130"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">  130</a></span>&#160;        <span class="keyword">private</span> <span class="keywordtype">bool</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">_tryGetBufferFailureLogged</a>;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeb3788fdaceb914a80cc33a5875e9ba7">  144</a></span>&#160;        <span class="keyword">internal</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeb3788fdaceb914a80cc33a5875e9ba7">WebSocketImplementation</a>(Guid guid, Func&lt;MemoryStream&gt; recycledStreamFactory, Stream stream,</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            TimeSpan keepAliveInterval, <span class="keywordtype">string</span> secWebSocketExtensions, <span class="keywordtype">bool</span> includeExceptionInCloseResponse,</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="keywordtype">bool</span> isClient, <span class="keywordtype">string</span> subProtocol)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a> = guid;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a> = recycledStreamFactory;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a> = stream;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a> = isClient;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b6bd28971f5f45e0e08095b37375305">SubProtocol</a> = subProtocol;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a> = <span class="keyword">new</span> CancellationTokenSource();</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.Open;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a> = <span class="keyword">new</span> <a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html">WebSocketReadCursor</a>(<span class="keyword">null</span>, 0, 0);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keywordflow">if</span> (secWebSocketExtensions?.IndexOf(<span class="stringliteral">&quot;permessage-deflate&quot;</span>) &gt;= 0)</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5f8d53537efa6b9c79df94fa84d8b3be">_usePerMessageDeflate</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a763d4f3b20bae5d7cf6f7388054788f8">UsePerMessageDeflate</a>(guid);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            }</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ad51ccc238732f156d4f63b1a0c69f0b5">NoMessageCompression</a>(guid);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9e8b89a2e7e1311f5cae8b8faf118a02">KeepAliveInterval</a> = keepAliveInterval;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a4515580f59eff64ada495876ee84a814">_includeExceptionInCloseResponse</a> = includeExceptionInCloseResponse;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            <span class="keywordflow">if</span> (keepAliveInterval.Ticks &lt; 0)</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="stringliteral">&quot;KeepAliveInterval must be Zero or positive&quot;</span>);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            <span class="keywordflow">if</span> (keepAliveInterval == TimeSpan.Zero)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aee180aa952fafd7d45f69792f48b90c4">KeepAliveIntervalZero</a>(guid);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a8f7ee9d53d72ace4dea95e4787259623">_pingPongManager</a> = <span class="keyword">new</span> <a class="code" href="../../da/d5f/class_alis_1_1_core_1_1_network_1_1_ping_pong_manager.html">PingPongManager</a>(guid, <span class="keyword">this</span>, keepAliveInterval, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>.Token);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af2c27569ac1004f4e881ef221029b683">  187</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> WebSocketCloseStatus? <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af2c27569ac1004f4e881ef221029b683">CloseStatus</a> =&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a1aa5bf101aa734ccb4184b035a969f2e">_closeStatus</a>;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0ce93552746ddee24e02959d24b01ef7">  192</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">string</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0ce93552746ddee24e02959d24b01ef7">CloseStatusDescription</a> =&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a33dc3b680b093f0aba60f92861d993a4">_closeStatusDescription</a>;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a763109aeafa8f5e6e2b6897ff0eb6b3d">  197</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> WebSocketState <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a763109aeafa8f5e6e2b6897ff0eb6b3d">State</a> =&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b6bd28971f5f45e0e08095b37375305">  202</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">string</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b6bd28971f5f45e0e08095b37375305">SubProtocol</a> { <span class="keyword">get</span>; }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9e8b89a2e7e1311f5cae8b8faf118a02">  207</a></span>&#160;        <span class="keyword">public</span> TimeSpan <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9e8b89a2e7e1311f5cae8b8faf118a02">KeepAliveInterval</a> { <span class="keyword">get</span>; }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeebcc90cd3665d2f1bf0f8a1408d06f8">  212</a></span>&#160;        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeebcc90cd3665d2f1bf0f8a1408d06f8">MaxPingPongPayloadLen</a> = 125;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a309dc585da3b64d0fdca66d21c650093">  214</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">event</span> EventHandler&lt;PongEventArgs&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a309dc585da3b64d0fdca66d21c650093">Pong</a>;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a3448af2125bb4a12f28ae143fee2f69d">  222</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> async Task&lt;WebSocketReceiveResult&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a3448af2125bb4a12f28ae143fee2f69d">ReceiveAsync</a>(ArraySegment&lt;byte&gt; buffer,</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            CancellationToken cancellationToken)</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            {</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                <span class="comment">// we may receive control frames so reading needs to happen in an infinite loop</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                {</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                    <span class="comment">// allow this operation to be cancelled from iniside OR outside this instance</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                    <span class="keyword">using</span> (CancellationTokenSource linkedCts =</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                           CancellationTokenSource.CreateLinkedTokenSource(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>.Token, cancellationToken))</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                    {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                        <a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html">WebSocketFrame</a> frame;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                        <span class="keywordflow">try</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                        {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a6974574a8bc92f1114c4a22c84a69bcd">NumBytesLeftToRead</a> &gt; 0)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                            {</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                                <span class="comment">// If the buffer used to read the frame was too small to fit the whole frame then we need to &quot;remember&quot; this frame</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                <span class="comment">// and return what we have. Subsequent calls to the read function will simply continue reading off the stream without </span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                                <span class="comment">// decoding the first few bytes as a websocket header.</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a> =</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                                    await <a class="code" href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html">WebSocketFrameReader</a>.<a class="code" href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html#ab72cf1644f44e7b6c39ae03b74552d1f">ReadFromCursorAsync</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a>, buffer, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>,</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                        linkedCts.Token);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                                frame = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a40149f29d1ef97e3f01770ad38312cdc">WebSocketFrame</a>;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                            }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                            {</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a> = await <a class="code" href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html">WebSocketFrameReader</a>.<a class="code" href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html#af33409b62a797e4aa9ef9118a47f6b4e">ReadAsync</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a>, buffer, linkedCts.Token);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                                frame = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a40149f29d1ef97e3f01770ad38312cdc">WebSocketFrame</a>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a1d9ee72f003bfeb5868054d8c2773755">ReceivedFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a23e45b8a75d2dc83a4d2f678685f6c55">OpCode</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">IsFinBitSet</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4784f4cb26b2096055ecfac51795ed12">Count</a>);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                            }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                        }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                        <span class="keywordflow">catch</span> (InternalBufferOverflowException ex)</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                        {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.MessageTooBig,</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                                <span class="stringliteral">&quot;Frame too large to fit in buffer. Use message fragmentation&quot;</span>, ex);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                            <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                        }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                        <span class="keywordflow">catch</span> (ArgumentOutOfRangeException ex)</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                        {</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.ProtocolError,</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                                <span class="stringliteral">&quot;Payload length out of range&quot;</span>, ex);</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                            <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                        }</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                        <span class="keywordflow">catch</span> (EndOfStreamException ex)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                        {</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.InvalidPayloadData,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                <span class="stringliteral">&quot;Unexpected end of stream encountered&quot;</span>, ex);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                            <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                        }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                        <span class="keywordflow">catch</span> (OperationCanceledException ex)</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                        {</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.EndpointUnavailable,</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                <span class="stringliteral">&quot;Operation cancelled&quot;</span>, ex);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                            <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                        }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                        <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                        {</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.InternalServerError,</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                <span class="stringliteral">&quot;Error reading WebSocket frame&quot;</span>, ex);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                            <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                        }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                        <span class="keywordtype">bool</span> endOfMessage = frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">IsFinBitSet</a> &amp;&amp; (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a6974574a8bc92f1114c4a22c84a69bcd">NumBytesLeftToRead</a> == 0);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                        <span class="keywordflow">switch</span> (frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a23e45b8a75d2dc83a4d2f678685f6c55">OpCode</a>)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                        {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose:</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                                <span class="keywordflow">return</span> await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0dfa061b79193b7f3eef0dcdb8cd1253">RespondToCloseFrame</a>(frame, buffer, linkedCts.Token);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Ping:</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                                ArraySegment&lt;byte&gt; pingPayload = <span class="keyword">new</span> ArraySegment&lt;byte&gt;(buffer.Array, buffer.Offset,</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">NumBytesRead</a>);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a35873b3f92b9436efa196b031e89f423">SendPongAsync</a>(pingPayload, linkedCts.Token);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Pong:</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                                ArraySegment&lt;byte&gt; pongBuffer = <span class="keyword">new</span> ArraySegment&lt;byte&gt;(buffer.Array,</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">NumBytesRead</a>, buffer.Offset);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a309dc585da3b64d0fdca66d21c650093">Pong</a>?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> <a class="code" href="../../d9/d70/class_alis_1_1_core_1_1_network_1_1_pong_event_args.html">PongEventArgs</a>(pongBuffer));</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.TextFrame:</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                <span class="keywordflow">if</span> (!frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">IsFinBitSet</a>)</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                                {</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                                    <span class="comment">// continuation frames will follow, record the message type Text</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">_continuationFrameMessageType</a> = WebSocketMessageType.Text;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                                }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                                <span class="keywordflow">return</span> <span class="keyword">new</span> WebSocketReceiveResult(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">NumBytesRead</a>, WebSocketMessageType.Text,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                                    endOfMessage);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.BinaryFrame:</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                                <span class="keywordflow">if</span> (!frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">IsFinBitSet</a>)</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                {</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                                    <span class="comment">// continuation frames will follow, record the message type Binary</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">_continuationFrameMessageType</a> = WebSocketMessageType.Binary;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                                }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                                <span class="keywordflow">return</span> <span class="keyword">new</span> WebSocketReceiveResult(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">NumBytesRead</a>, WebSocketMessageType.Binary,</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                                    endOfMessage);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                            <span class="keywordflow">case</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ContinuationFrame:</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                                <span class="keywordflow">return</span> <span class="keyword">new</span> WebSocketReceiveResult(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">_readCursor</a>.<a class="code" href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">NumBytesRead</a>,</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">_continuationFrameMessageType</a>, endOfMessage);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                            <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                                Exception ex = <span class="keyword">new</span> NotSupportedException($<span class="stringliteral">&quot;Unknown WebSocket opcode {frame.OpCode}&quot;</span>);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.ProtocolError, ex.Message, ex);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                                <span class="keywordflow">throw</span> ex;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                        }</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                    }</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                }</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            <span class="keywordflow">catch</span> (Exception catchAll)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            {</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                <span class="comment">// Most exceptions will be caught closer to their source to send an appropriate close message (and set the WebSocketState)</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <span class="comment">// However, if an unhandled exception is encountered and a close message not sent then send one here</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                {</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                    await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.InternalServerError,</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                        <span class="stringliteral">&quot;Unexpected error reading from WebSocket&quot;</span>, catchAll);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a84c2deca93283a8eb514ef28c543d8e8">  354</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a84c2deca93283a8eb514ef28c543d8e8">SendAsync</a>(ArraySegment&lt;byte&gt; buffer, WebSocketMessageType messageType,</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            <span class="keywordtype">bool</span> endOfMessage, CancellationToken cancellationToken)</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        {</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            {</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a> opCode = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a977ee8b322d9590c8b58fbeb1cda70c8">GetOppCode</a>(messageType);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5f8d53537efa6b9c79df94fa84d8b3be">_usePerMessageDeflate</a>)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                {</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    <span class="comment">// NOTE: Compression is currently work in progress and should NOT be used in this library.</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    <span class="comment">// The code below is very inefficient for small messages. Ideally we would like to have some sort of moving window</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                    <span class="comment">// of data to get the best compression. And we don&#39;t want to create new buffers which is bad for GC.</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                    <span class="keyword">using</span> (MemoryStream temp = <span class="keyword">new</span> MemoryStream())</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    {</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                        DeflateStream deflateStream = <span class="keyword">new</span> DeflateStream(temp, CompressionMode.Compress);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                        deflateStream.Write(buffer.Array, buffer.Offset, buffer.Count);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                        deflateStream.Flush();</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                        ArraySegment&lt;byte&gt; compressedBuffer = <span class="keyword">new</span> ArraySegment&lt;byte&gt;(temp.ToArray());</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                        <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(opCode, compressedBuffer, stream, endOfMessage, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                        <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, opCode, endOfMessage, compressedBuffer.Count, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                    }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(opCode, buffer, stream, endOfMessage, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, opCode, endOfMessage, buffer.Count, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                }</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160; </div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, cancellationToken);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#afab6be1a75087a1817471656cfb1023f">_isContinuationFrame</a> = !endOfMessage; </div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            }</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00391"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a17d292f91f10ea2d303f1f03d99c159e">  391</a></span>&#160;        <span class="keyword">public</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a17d292f91f10ea2d303f1f03d99c159e">SendPingAsync</a>(ArraySegment&lt;byte&gt; payload, CancellationToken cancellationToken)</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        {</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            <span class="keywordflow">if</span> (payload.Count &gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeebcc90cd3665d2f1bf0f8a1408d06f8">MaxPingPongPayloadLen</a>)</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            {</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidOperationException(</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                    $<span class="stringliteral">&quot;Cannot send Ping: Max ping message size {MaxPingPongPayloadLen} exceeded: {payload.Count}&quot;</span>);</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            }</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160; </div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                    <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(<a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Ping, payload, stream, <span class="keyword">true</span>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Ping, <span class="keyword">true</span>, payload.Count, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                    await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, cancellationToken);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            }</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a284f03021e7ecdf23a1178d6d9b05c97">  413</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a284f03021e7ecdf23a1178d6d9b05c97">Abort</a>()</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.Aborted;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>.Cancel();</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0971f376ca0011d325c291dbbd26b90f">  422</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0971f376ca0011d325c291dbbd26b90f">CloseAsync</a>(WebSocketCloseStatus closeStatus, <span class="keywordtype">string</span> statusDescription,</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            CancellationToken cancellationToken)</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                    ArraySegment&lt;byte&gt; buffer = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b164ade1c7448160bb4ff8d376af394">BuildClosePayload</a>(closeStatus, statusDescription);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                    <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(<a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, buffer, stream, <span class="keyword">true</span>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a423492501480517b1456ced3ae596592">CloseHandshakeStarted</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, closeStatus, statusDescription);</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, <span class="keyword">true</span>, buffer.Count, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                    await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, cancellationToken);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.CloseSent;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            }</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a3ebf60c25fa564f7a8bbde23118c1f3c">InvalidStateBeforeClose</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00446"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ae01d25355d19af3719804e23d551aac5">  446</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ae01d25355d19af3719804e23d551aac5">CloseOutputAsync</a>(WebSocketCloseStatus closeStatus, <span class="keywordtype">string</span> statusDescription,</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            CancellationToken cancellationToken)</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        {</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            {</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.Closed; <span class="comment">// set this before we write to the network because the write may fail</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                {</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                    ArraySegment&lt;byte&gt; buffer = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b164ade1c7448160bb4ff8d376af394">BuildClosePayload</a>(closeStatus, statusDescription);</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                    <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(<a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, buffer, stream, <span class="keyword">true</span>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aea07179bbe953549fe6f8b7481c73a08">CloseOutputNoHandshake</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, closeStatus, statusDescription);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, <span class="keyword">true</span>, buffer.Count, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                    await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, cancellationToken);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                }</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            }</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            {</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a3f3c85f8f4f325a614bc99dcbde1a537">InvalidStateBeforeCloseOutput</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            }</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            <span class="comment">// cancel pending reads</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>.Cancel();</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        }</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ac8d2a6f85fb5299d749cd84e0940714c">  474</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ac8d2a6f85fb5299d749cd84e0940714c">Dispose</a>()</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a34feee301c6cc2fc0b88e1fc85a501a7">WebSocketDispose</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>);</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160; </div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            {</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                {</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    CancellationTokenSource cts = <span class="keyword">new</span> CancellationTokenSource(TimeSpan.FromSeconds(5));</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                    {</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                        <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ae01d25355d19af3719804e23d551aac5">CloseOutputAsync</a>(WebSocketCloseStatus.EndpointUnavailable, <span class="stringliteral">&quot;Service is Disposed&quot;</span>, cts.Token)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                            .Wait();</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                    }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                    <span class="keywordflow">catch</span> (OperationCanceledException)</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                    {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                        <span class="comment">// log don&#39;t throw</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                        <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a782a73e4f8f4875e50670bfac4d2e5ad">WebSocketDisposeCloseTimeout</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>);</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                    }</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                }</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160; </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                <span class="comment">// cancel pending reads - usually does nothing</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">_internalReadCts</a>.Cancel();</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a>.Close();</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;            {</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                <span class="comment">// log dont throw</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aeec523d4d288dcdbca16a56286a56495">WebSocketDisposeError</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>, ex.ToString());</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        }</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160; </div>
<div class="line"><a name="l00510"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af9d1a2b079e9216e1821ac1053f776ed">  510</a></span>&#160;        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af9d1a2b079e9216e1821ac1053f776ed">OnPong</a>(<a class="code" href="../../d9/d70/class_alis_1_1_core_1_1_network_1_1_pong_event_args.html">PongEventArgs</a> e)</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        {</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a309dc585da3b64d0fdca66d21c650093">Pong</a>?.Invoke(<span class="keyword">this</span>, e);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b164ade1c7448160bb4ff8d376af394">  521</a></span>&#160;        <span class="keyword">private</span> ArraySegment&lt;byte&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b164ade1c7448160bb4ff8d376af394">BuildClosePayload</a>(WebSocketCloseStatus closeStatus, <span class="keywordtype">string</span> statusDescription)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        {</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            <span class="keywordtype">byte</span>[] statusBuffer = BitConverter.GetBytes((ushort) closeStatus);</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            Array.Reverse(statusBuffer); <span class="comment">// network byte order (big endian)</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160; </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            <span class="keywordflow">if</span> (statusDescription == <span class="keyword">null</span>)</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(statusBuffer);</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            }</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160; </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            <span class="keywordtype">byte</span>[] descBuffer = Encoding.UTF8.GetBytes(statusDescription);</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordtype">byte</span>[] payload = <span class="keyword">new</span> <span class="keywordtype">byte</span>[statusBuffer.Length + descBuffer.Length];</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            Buffer.BlockCopy(statusBuffer, 0, payload, 0, statusBuffer.Length);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            Buffer.BlockCopy(descBuffer, 0, payload, statusBuffer.Length, descBuffer.Length);</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(payload);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        }</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00540"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a35873b3f92b9436efa196b031e89f423">  540</a></span>&#160;        <span class="keyword">private</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a35873b3f92b9436efa196b031e89f423">SendPongAsync</a>(ArraySegment&lt;byte&gt; payload, CancellationToken cancellationToken)</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        {</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            <span class="comment">// as per websocket spec</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="keywordflow">if</span> (payload.Count &gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeebcc90cd3665d2f1bf0f8a1408d06f8">MaxPingPongPayloadLen</a>)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                Exception ex =</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                    <span class="keyword">new</span> InvalidOperationException(</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                        $<span class="stringliteral">&quot;Max ping message size {MaxPingPongPayloadLen} exceeded: {payload.Count}&quot;</span>);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.ProtocolError, ex.Message, ex);</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                <span class="keywordflow">throw</span> ex;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            }</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            {</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                    <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                    {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                        <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(<a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Pong, payload, stream, <span class="keyword">true</span>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                        <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.Pong, <span class="keyword">true</span>, payload.Count, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                        await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, cancellationToken);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                    }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                }</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            }</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus.EndpointUnavailable,</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                    <span class="stringliteral">&quot;Unable to send Pong response&quot;</span>, ex);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            }</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        }</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160; </div>
<div class="line"><a name="l00576"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0dfa061b79193b7f3eef0dcdb8cd1253">  576</a></span>&#160;        <span class="keyword">private</span> async Task&lt;WebSocketReceiveResult&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0dfa061b79193b7f3eef0dcdb8cd1253">RespondToCloseFrame</a>(<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html">WebSocketFrame</a> frame, ArraySegment&lt;byte&gt; buffer,</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            CancellationToken token)</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        {</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a1aa5bf101aa734ccb4184b035a969f2e">_closeStatus</a> = frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#aea74e4d47dce2250aa77882cb6353b84">CloseStatus</a>;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a33dc3b680b093f0aba60f92861d993a4">_closeStatusDescription</a> = frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a610cb84f1696967706a31fa9428b41a0">CloseStatusDescription</a>;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160; </div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.CloseSent)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                <span class="comment">// this is a response to close handshake initiated by this instance</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.Closed;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a07194615353187017f499e95b427d1bf">CloseHandshakeComplete</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>);</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            }</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> == WebSocketState.Open)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            {</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                <span class="comment">// do not echo the close payload back to the client, there is no requirement for it in the spec. </span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                <span class="comment">// However, the same CloseStatus as recieved should be sent back.</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                ArraySegment&lt;byte&gt; closePayload = <span class="keyword">new</span> ArraySegment&lt;byte&gt;(<span class="keyword">new</span> <span class="keywordtype">byte</span>[0], 0, 0);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a> = WebSocketState.CloseReceived;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a4d6c4f1468950e2b565b4db1d39036d0">CloseHandshakeRespond</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#aea74e4d47dce2250aa77882cb6353b84">CloseStatus</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a610cb84f1696967706a31fa9428b41a0">CloseStatusDescription</a>);</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160; </div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                <span class="keyword">using</span> (MemoryStream stream = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">_recycledStreamFactory</a>())</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                {</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                    <a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">WebSocketFrameWriter</a>.<a class="code" href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Write</a>(<a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, closePayload, stream, <span class="keyword">true</span>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">_isClient</a>);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">SendingFrame</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ConnectionClose, <span class="keyword">true</span>, closePayload.Count, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                    await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(stream, token);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                }</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            }</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            {</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a0ef37bd0a04a2ec29c7225fbce0ee0ab">CloseFrameReceivedInUnexpectedState</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">_state</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#aea74e4d47dce2250aa77882cb6353b84">CloseStatus</a>,</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                    frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a610cb84f1696967706a31fa9428b41a0">CloseStatusDescription</a>);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160; </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">new</span> WebSocketReceiveResult(frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4784f4cb26b2096055ecfac51795ed12">Count</a>, WebSocketMessageType.Close, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">IsFinBitSet</a>,</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#aea74e4d47dce2250aa77882cb6353b84">CloseStatus</a>, frame.<a class="code" href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a610cb84f1696967706a31fa9428b41a0">CloseStatusDescription</a>);</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160; </div>
<div class="line"><a name="l00618"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abc88a19909e68d04eaa2f8b6a47fe2b8">  618</a></span>&#160;        <span class="keyword">private</span> ArraySegment&lt;byte&gt; <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abc88a19909e68d04eaa2f8b6a47fe2b8">GetBuffer</a>(MemoryStream stream)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        {</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="preprocessor">#if NET45</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            <span class="comment">// NET45 does not have a TryGetBuffer function on Stream</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">_tryGetBufferFailureLogged</a>)</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            {</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(stream.ToArray(), 0, (<span class="keywordtype">int</span>)stream.Position);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160; </div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="comment">// note that a MemoryStream will throw an UnuthorizedAccessException if the internal buffer is not public. Set publiclyVisible = true</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            {</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(stream.GetBuffer(), 0, (<span class="keywordtype">int</span>)stream.Position);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            }</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            <span class="keywordflow">catch</span> (UnauthorizedAccessException)</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            {</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a57ca1eb8d26b8263c587e9e264820f39">TryGetBufferNotSupported</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, stream?.GetType()?.ToString());</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">_tryGetBufferFailureLogged</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(stream.ToArray(), 0, (<span class="keywordtype">int</span>)stream.Position);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            }</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            <span class="comment">// Avoid calling ToArray on the MemoryStream because it allocates a new byte array on tha heap</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            <span class="comment">// We avaoid this by attempting to access the internal memory stream buffer</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="comment">// This works with supported streams like the recyclable memory stream and writable memory streams</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            <span class="keywordflow">if</span> (!stream.TryGetBuffer(out ArraySegment&lt;byte&gt; buffer))</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;            {</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">_tryGetBufferFailureLogged</a>)</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                {</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                    <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a57ca1eb8d26b8263c587e9e264820f39">TryGetBufferNotSupported</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, stream?.GetType()?.ToString());</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                    <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">_tryGetBufferFailureLogged</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                }</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160; </div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                <span class="comment">// internal buffer not suppoted, fall back to ToArray()</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                <span class="keywordtype">byte</span>[] array = stream.ToArray();</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                buffer = <span class="keyword">new</span> ArraySegment&lt;byte&gt;(array, 0, array.Length);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            }</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160; </div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">new</span> ArraySegment&lt;byte&gt;(buffer.Array, buffer.Offset, (<span class="keywordtype">int</span>) stream.Position);</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        }</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160; </div>
<div class="line"><a name="l00664"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">  664</a></span>&#160;        <span class="keyword">private</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">WriteStreamToNetwork</a>(MemoryStream stream, CancellationToken cancellationToken)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        {</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            ArraySegment&lt;byte&gt; buffer = <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abc88a19909e68d04eaa2f8b6a47fe2b8">GetBuffer</a>(stream);</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a130c0dd79df32564fbf4e8d175f7e62e">_semaphore</a>.WaitAsync(cancellationToken).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            {</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">_stream</a>.WriteAsync(buffer.Array, buffer.Offset, buffer.Count, cancellationToken)</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                    .ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            <span class="keywordflow">finally</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            {</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a130c0dd79df32564fbf4e8d175f7e62e">_semaphore</a>.Release();</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;            }</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        }</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a977ee8b322d9590c8b58fbeb1cda70c8">  682</a></span>&#160;        <span class="keyword">private</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a> <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a977ee8b322d9590c8b58fbeb1cda70c8">GetOppCode</a>(WebSocketMessageType messageType)</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        {</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#afab6be1a75087a1817471656cfb1023f">_isContinuationFrame</a>)</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            {</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.ContinuationFrame;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            }</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160; </div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <span class="keywordflow">switch</span> (messageType)</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            {</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                <span class="keywordflow">case</span> WebSocketMessageType.Binary:</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.BinaryFrame;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                <span class="keywordflow">case</span> WebSocketMessageType.Text:</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">WebSocketOpCode</a>.TextFrame;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                <span class="keywordflow">case</span> WebSocketMessageType.Close:</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                    <span class="keywordflow">throw</span> <span class="keyword">new</span> NotSupportedException(</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                        <span class="stringliteral">&quot;Cannot use Send function to send a close frame. Use Close function.&quot;</span>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                    <span class="keywordflow">throw</span> <span class="keyword">new</span> NotSupportedException($<span class="stringliteral">&quot;MessageType {messageType} not supported&quot;</span>);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            }</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        }</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160; </div>
<div class="line"><a name="l00709"></a><span class="lineno"><a class="line" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">  709</a></span>&#160;        <span class="keyword">private</span> async Task <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">CloseOutputAutoTimeoutAsync</a>(WebSocketCloseStatus closeStatus, <span class="keywordtype">string</span> statusDescription,</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            Exception ex)</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        {</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;            TimeSpan timeSpan = TimeSpan.FromSeconds(5);</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a5a54b0ade428135a838827f740ad9aba">CloseOutputAutoTimeout</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, closeStatus, statusDescription, ex.ToString());</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            <span class="keywordflow">try</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            {</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                <span class="comment">// we may not want to send sensitive information to the client / server</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a4515580f59eff64ada495876ee84a814">_includeExceptionInCloseResponse</a>)</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                {</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                    statusDescription = statusDescription + <span class="stringliteral">&quot;\r\n\r\n&quot;</span> + ex;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                }</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160; </div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                CancellationTokenSource autoCancel = <span class="keyword">new</span> CancellationTokenSource(timeSpan);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                await <a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ae01d25355d19af3719804e23d551aac5">CloseOutputAsync</a>(closeStatus, statusDescription, autoCancel.Token);</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            }</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            <span class="keywordflow">catch</span> (OperationCanceledException)</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            {</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                <span class="comment">// do not throw an exception because that will mask the original exception</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#abe46a9580b6a3dd2855e19783f9f2efc">CloseOutputAutoTimeoutCancelled</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, (<span class="keywordtype">int</span>) timeSpan.TotalSeconds, closeStatus,</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                    statusDescription, ex.ToString());</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            }</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            <span class="keywordflow">catch</span> (Exception closeException)</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            {</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                <span class="comment">// do not throw an exception because that will mask the original exception</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                <a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Events</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Log</a>.<a class="code" href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a792e8711385348448f343ac7fab704de">CloseOutputAutoTimeoutError</a>(<a class="code" href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">_guid</a>, closeException.ToString(), closeStatus, statusDescription,</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                    ex.ToString());</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            }</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    }</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader_html"><div class="ttname"><a href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html">Alis.Core.Network.Internal.WebSocketFrameReader</a></div><div class="ttdoc">Reads a WebSocket frame see http://tools.ietf.org/html/rfc6455 for specification</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d06/_web_socket_frame_reader_8cs_source.html#l00043">WebSocketFrameReader.cs:44</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader_html_ab72cf1644f44e7b6c39ae03b74552d1f"><div class="ttname"><a href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html#ab72cf1644f44e7b6c39ae03b74552d1f">Alis.Core.Network.Internal.WebSocketFrameReader.ReadFromCursorAsync</a></div><div class="ttdeci">static async Task&lt; WebSocketReadCursor &gt; ReadFromCursorAsync(Stream fromStream, ArraySegment&lt; byte &gt; intoBuffer, WebSocketReadCursor readCursor, CancellationToken cancellationToken)</div><div class="ttdoc">The last read could not be completed because the read buffer was too small. We need to continue readi...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d06/_web_socket_frame_reader_8cs_source.html#l00072">WebSocketFrameReader.cs:72</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a423492501480517b1456ced3ae596592"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a423492501480517b1456ced3ae596592">Alis.Core.Network.Internal.Events.CloseHandshakeStarted</a></div><div class="ttdeci">void CloseHandshakeStarted(Guid guid, WebSocketCloseStatus? closeStatus, string statusDescription)</div><div class="ttdoc">Closes the handshake started using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00487">Events.cs:487</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a35873b3f92b9436efa196b031e89f423"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a35873b3f92b9436efa196b031e89f423">Alis.Core.Network.Internal.WebSocketImplementation.SendPongAsync</a></div><div class="ttdeci">async Task SendPongAsync(ArraySegment&lt; byte &gt; payload, CancellationToken cancellationToken)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00540">WebSocketImplementation.cs:540</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a16c2a4ea89a24451cb6cfa906958b356"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a16c2a4ea89a24451cb6cfa906958b356">Alis.Core.Network.Internal.Events.Log</a></div><div class="ttdeci">static Events Log</div><div class="ttdoc">The events</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00047">Events.cs:47</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a0ef37bd0a04a2ec29c7225fbce0ee0ab"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a0ef37bd0a04a2ec29c7225fbce0ee0ab">Alis.Core.Network.Internal.Events.CloseFrameReceivedInUnexpectedState</a></div><div class="ttdeci">void CloseFrameReceivedInUnexpectedState(Guid guid, WebSocketState webSocketState, WebSocketCloseStatus? closeStatus, string statusDescription)</div><div class="ttdoc">Closes the frame received in unexpected state using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00533">Events.cs:533</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a32a24a099ce4ac02eab9fe30f21d1c0b"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a32a24a099ce4ac02eab9fe30f21d1c0b">Alis.Core.Network.Internal.WebSocketImplementation._tryGetBufferFailureLogged</a></div><div class="ttdeci">bool _tryGetBufferFailureLogged</div><div class="ttdoc">The try get buffer failure logged</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00130">WebSocketImplementation.cs:130</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a763d4f3b20bae5d7cf6f7388054788f8"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a763d4f3b20bae5d7cf6f7388054788f8">Alis.Core.Network.Internal.Events.UsePerMessageDeflate</a></div><div class="ttdeci">void UsePerMessageDeflate(Guid guid)</div><div class="ttdoc">Uses the per message deflate using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00286">Events.cs:286</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a4d6c4f1468950e2b565b4db1d39036d0"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a4d6c4f1468950e2b565b4db1d39036d0">Alis.Core.Network.Internal.Events.CloseHandshakeRespond</a></div><div class="ttdeci">void CloseHandshakeRespond(Guid guid, WebSocketCloseStatus? closeStatus, string statusDescription)</div><div class="ttdoc">Closes the handshake respond using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00503">Events.cs:503</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a33dc3b680b093f0aba60f92861d993a4"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a33dc3b680b093f0aba60f92861d993a4">Alis.Core.Network.Internal.WebSocketImplementation._closeStatusDescription</a></div><div class="ttdeci">string _closeStatusDescription</div><div class="ttdoc">The close status description</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00105">WebSocketImplementation.cs:105</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a4515580f59eff64ada495876ee84a814"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a4515580f59eff64ada495876ee84a814">Alis.Core.Network.Internal.WebSocketImplementation._includeExceptionInCloseResponse</a></div><div class="ttdeci">readonly bool _includeExceptionInCloseResponse</div><div class="ttdoc">The include exception in close response</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00060">WebSocketImplementation.cs:60</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html">Alis.Core.Network.Internal.Events</a></div><div class="ttdoc">Use the Guid to locate this EventSource in PerfView using the Additional Providers box (without wildc...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00042">Events.cs:43</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a309dc585da3b64d0fdca66d21c650093"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a309dc585da3b64d0fdca66d21c650093">Alis.Core.Network.Internal.WebSocketImplementation.Pong</a></div><div class="ttdeci">EventHandler&lt; PongEventArgs &gt; Pong</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00214">WebSocketImplementation.cs:214</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_ae01d25355d19af3719804e23d551aac5"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ae01d25355d19af3719804e23d551aac5">Alis.Core.Network.Internal.WebSocketImplementation.CloseOutputAsync</a></div><div class="ttdeci">override async Task CloseOutputAsync(WebSocketCloseStatus closeStatus, string statusDescription, CancellationToken cancellationToken)</div><div class="ttdoc">Fire and forget close</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00446">WebSocketImplementation.cs:446</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a3ebf60c25fa564f7a8bbde23118c1f3c"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a3ebf60c25fa564f7a8bbde23118c1f3c">Alis.Core.Network.Internal.Events.InvalidStateBeforeClose</a></div><div class="ttdeci">void InvalidStateBeforeClose(Guid guid, WebSocketState webSocketState)</div><div class="ttdoc">Invalids the state before close using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00592">Events.cs:592</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html">Alis.Core.Network.Internal.WebSocketImplementation</a></div><div class="ttdoc">Main implementation of the WebSocket abstract class</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00050">WebSocketImplementation.cs:51</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_ae5a1fa60bcf236ac3d48d81eb9ec2b26"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ae5a1fa60bcf236ac3d48d81eb9ec2b26">Alis.Core.Network.Internal.Events.SendingFrame</a></div><div class="ttdeci">void SendingFrame(Guid guid, WebSocketOpCode webSocketOpCode, bool isFinBitSet, int numBytes, bool isPayloadCompressed)</div><div class="ttdoc">Sendings the frame using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00439">Events.cs:439</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a284f03021e7ecdf23a1178d6d9b05c97"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a284f03021e7ecdf23a1178d6d9b05c97">Alis.Core.Network.Internal.WebSocketImplementation.Abort</a></div><div class="ttdeci">override void Abort()</div><div class="ttdoc">Aborts the WebSocket without sending a Close frame</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00413">WebSocketImplementation.cs:413</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a8f7ee9d53d72ace4dea95e4787259623"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a8f7ee9d53d72ace4dea95e4787259623">Alis.Core.Network.Internal.WebSocketImplementation._pingPongManager</a></div><div class="ttdeci">readonly IPingPongManager _pingPongManager</div><div class="ttdoc">The ping pong manager</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00075">WebSocketImplementation.cs:75</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a9e8b89a2e7e1311f5cae8b8faf118a02"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9e8b89a2e7e1311f5cae8b8faf118a02">Alis.Core.Network.Internal.WebSocketImplementation.KeepAliveInterval</a></div><div class="ttdeci">TimeSpan KeepAliveInterval</div><div class="ttdoc">Gets the value of the keep alive interval</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00207">WebSocketImplementation.cs:207</a></div></div>
<div class="ttc" id="anamespace_alis_1_1_core_1_1_network_1_1_internal_html"><div class="ttname"><a href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html">Alis.Core.Network.Internal</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d88/_binary_reader_writer_8cs_source.html#l00035">BinaryReaderWriter.cs:36</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_aeec523d4d288dcdbca16a56286a56495"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aeec523d4d288dcdbca16a56286a56495">Alis.Core.Network.Internal.Events.WebSocketDisposeError</a></div><div class="ttdeci">void WebSocketDisposeError(Guid guid, WebSocketState webSocketState, string exception)</div><div class="ttdoc">Webs the socket dispose error using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00578">Events.cs:578</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5b6bd28971f5f45e0e08095b37375305"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b6bd28971f5f45e0e08095b37375305">Alis.Core.Network.Internal.WebSocketImplementation.SubProtocol</a></div><div class="ttdeci">override string SubProtocol</div><div class="ttdoc">Gets the value of the sub protocol</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00202">WebSocketImplementation.cs:202</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html_a4784f4cb26b2096055ecfac51795ed12"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4784f4cb26b2096055ecfac51795ed12">Alis.Core.Network.Internal.WebSocketFrame.Count</a></div><div class="ttdeci">int Count</div><div class="ttdoc">Gets the value of the count</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00085">WebSocketFrame.cs:85</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_aacd9e74a407e09c2809f77ae23aa0448"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aacd9e74a407e09c2809f77ae23aa0448">Alis.Core.Network.Internal.WebSocketImplementation._state</a></div><div class="ttdeci">WebSocketState _state</div><div class="ttdoc">The state</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00125">WebSocketImplementation.cs:125</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_aeebcc90cd3665d2f1bf0f8a1408d06f8"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeebcc90cd3665d2f1bf0f8a1408d06f8">Alis.Core.Network.Internal.WebSocketImplementation.MaxPingPongPayloadLen</a></div><div class="ttdeci">const int MaxPingPongPayloadLen</div><div class="ttdoc">The max ping pong payload len</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00212">WebSocketImplementation.cs:212</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_aeb3788fdaceb914a80cc33a5875e9ba7"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aeb3788fdaceb914a80cc33a5875e9ba7">Alis.Core.Network.Internal.WebSocketImplementation.WebSocketImplementation</a></div><div class="ttdeci">WebSocketImplementation(Guid guid, Func&lt; MemoryStream &gt; recycledStreamFactory, Stream stream, TimeSpan keepAliveInterval, string secWebSocketExtensions, bool includeExceptionInCloseResponse, bool isClient, string subProtocol)</div><div class="ttdoc">Initializes a new instance of the WebSocketImplementation class</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00144">WebSocketImplementation.cs:144</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html_aea74e4d47dce2250aa77882cb6353b84"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#aea74e4d47dce2250aa77882cb6353b84">Alis.Core.Network.Internal.WebSocketFrame.CloseStatus</a></div><div class="ttdeci">WebSocketCloseStatus? CloseStatus</div><div class="ttdoc">Gets the value of the close status</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00090">WebSocketFrame.cs:90</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_aae4175596662450311f5624a709e9701"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#aae4175596662450311f5624a709e9701">Alis.Core.Network.Internal.WebSocketImplementation._recycledStreamFactory</a></div><div class="ttdeci">readonly Func&lt; MemoryStream &gt; _recycledStreamFactory</div><div class="ttdoc">The recycled stream factory</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00080">WebSocketImplementation.cs:80</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html_a610cb84f1696967706a31fa9428b41a0"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a610cb84f1696967706a31fa9428b41a0">Alis.Core.Network.Internal.WebSocketFrame.CloseStatusDescription</a></div><div class="ttdeci">string CloseStatusDescription</div><div class="ttdoc">Gets the value of the close status description</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00095">WebSocketFrame.cs:95</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_aea07179bbe953549fe6f8b7481c73a08"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aea07179bbe953549fe6f8b7481c73a08">Alis.Core.Network.Internal.Events.CloseOutputNoHandshake</a></div><div class="ttdeci">void CloseOutputNoHandshake(Guid guid, WebSocketCloseStatus? closeStatus, string statusDescription)</div><div class="ttdoc">Closes the output no handshake using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00471">Events.cs:471</a></div></div>
<div class="ttc" id="ainterface_alis_1_1_core_1_1_network_1_1_i_ping_pong_manager_html"><div class="ttname"><a href="../../de/df6/interface_alis_1_1_core_1_1_network_1_1_i_ping_pong_manager.html">Alis.Core.Network.IPingPongManager</a></div><div class="ttdoc">Ping Pong Manager used to facilitate ping pong WebSocket messages</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d52/_i_ping_pong_manager_8cs_source.html#l00039">IPingPongManager.cs:40</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a0dfa061b79193b7f3eef0dcdb8cd1253"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0dfa061b79193b7f3eef0dcdb8cd1253">Alis.Core.Network.Internal.WebSocketImplementation.RespondToCloseFrame</a></div><div class="ttdeci">async Task&lt; WebSocketReceiveResult &gt; RespondToCloseFrame(WebSocketFrame frame, ArraySegment&lt; byte &gt; buffer, CancellationToken token)</div><div class="ttdoc">Called when a Close frame is received Send a response close frame if applicable</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00576">WebSocketImplementation.cs:576</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_ac8d2a6f85fb5299d749cd84e0940714c"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#ac8d2a6f85fb5299d749cd84e0940714c">Alis.Core.Network.Internal.WebSocketImplementation.Dispose</a></div><div class="ttdeci">override void Dispose()</div><div class="ttdoc">Dispose will send a close frame if the connection is still open</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00474">WebSocketImplementation.cs:474</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor_html_acce04f7032cab5914ce06029bf3db6b5"><div class="ttname"><a href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#acce04f7032cab5914ce06029bf3db6b5">Alis.Core.Network.Internal.WebSocketReadCursor.NumBytesRead</a></div><div class="ttdeci">int NumBytesRead</div><div class="ttdoc">Gets the value of the num bytes read</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d0a/_web_socket_read_cursor_8cs_source.html#l00059">WebSocketReadCursor.cs:59</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_abc88a19909e68d04eaa2f8b6a47fe2b8"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abc88a19909e68d04eaa2f8b6a47fe2b8">Alis.Core.Network.Internal.WebSocketImplementation.GetBuffer</a></div><div class="ttdeci">ArraySegment&lt; byte &gt; GetBuffer(MemoryStream stream)</div><div class="ttdoc">Note that the way in which the stream buffer is accessed can lead to significant performance problems...</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00618">WebSocketImplementation.cs:618</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_ad51ccc238732f156d4f63b1a0c69f0b5"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#ad51ccc238732f156d4f63b1a0c69f0b5">Alis.Core.Network.Internal.Events.NoMessageCompression</a></div><div class="ttdeci">void NoMessageCompression(Guid guid)</div><div class="ttdoc">Noes the message compression using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00299">Events.cs:299</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a0ce93552746ddee24e02959d24b01ef7"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0ce93552746ddee24e02959d24b01ef7">Alis.Core.Network.Internal.WebSocketImplementation.CloseStatusDescription</a></div><div class="ttdeci">override string CloseStatusDescription</div><div class="ttdoc">Gets the value of the close status description</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00192">WebSocketImplementation.cs:192</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a34feee301c6cc2fc0b88e1fc85a501a7"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a34feee301c6cc2fc0b88e1fc85a501a7">Alis.Core.Network.Internal.Events.WebSocketDispose</a></div><div class="ttdeci">void WebSocketDispose(Guid guid, WebSocketState webSocketState)</div><div class="ttdoc">Webs the socket dispose using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00549">Events.cs:549</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor_html"><div class="ttname"><a href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html">Alis.Core.Network.Internal.WebSocketReadCursor</a></div><div class="ttdoc">The web socket read cursor class</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d0a/_web_socket_read_cursor_8cs_source.html#l00035">WebSocketReadCursor.cs:36</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a1d9ee72f003bfeb5868054d8c2773755"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a1d9ee72f003bfeb5868054d8c2773755">Alis.Core.Network.Internal.Events.ReceivedFrame</a></div><div class="ttdeci">void ReceivedFrame(Guid guid, WebSocketOpCode webSocketOpCode, bool isFinBitSet, int numBytes)</div><div class="ttdoc">Receiveds the frame using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00456">Events.cs:456</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a3448af2125bb4a12f28ae143fee2f69d"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a3448af2125bb4a12f28ae143fee2f69d">Alis.Core.Network.Internal.WebSocketImplementation.ReceiveAsync</a></div><div class="ttdeci">override async Task&lt; WebSocketReceiveResult &gt; ReceiveAsync(ArraySegment&lt; byte &gt; buffer, CancellationToken cancellationToken)</div><div class="ttdoc">Receive web socket result</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00222">WebSocketImplementation.cs:222</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_pong_event_args_html"><div class="ttname"><a href="../../d9/d70/class_alis_1_1_core_1_1_network_1_1_pong_event_args.html">Alis.Core.Network.PongEventArgs</a></div><div class="ttdoc">Pong EventArgs</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dff/_pong_event_args_8cs_source.html#l00037">PongEventArgs.cs:38</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a6b6be9d51bf8d5caf320f24b9093dae4"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a6b6be9d51bf8d5caf320f24b9093dae4">Alis.Core.Network.Internal.WebSocketImplementation._guid</a></div><div class="ttdeci">readonly Guid _guid</div><div class="ttdoc">The guid</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00055">WebSocketImplementation.cs:55</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a9c62b2c3568e936f02c55159f12c67bf"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a9c62b2c3568e936f02c55159f12c67bf">Alis.Core.Network.Internal.WebSocketImplementation.WriteStreamToNetwork</a></div><div class="ttdeci">async Task WriteStreamToNetwork(MemoryStream stream, CancellationToken cancellationToken)</div><div class="ttdoc">Puts data on the wire</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00664">WebSocketImplementation.cs:664</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a5a54b0ade428135a838827f740ad9aba"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a5a54b0ade428135a838827f740ad9aba">Alis.Core.Network.Internal.Events.CloseOutputAutoTimeout</a></div><div class="ttdeci">void CloseOutputAutoTimeout(Guid guid, WebSocketCloseStatus closeStatus, string statusDescription, string exception)</div><div class="ttdoc">Closes the output auto timeout using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00369">Events.cs:369</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a17d292f91f10ea2d303f1f03d99c159e"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a17d292f91f10ea2d303f1f03d99c159e">Alis.Core.Network.Internal.WebSocketImplementation.SendPingAsync</a></div><div class="ttdeci">async Task SendPingAsync(ArraySegment&lt; byte &gt; payload, CancellationToken cancellationToken)</div><div class="ttdoc">Call this automatically from server side each keepAliveInterval period NOTE: ping payload must be 125...</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00391">WebSocketImplementation.cs:391</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html_a4e41f2667dcc65d0ec7454af59be3d4e"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a4e41f2667dcc65d0ec7454af59be3d4e">Alis.Core.Network.Internal.WebSocketFrame.IsFinBitSet</a></div><div class="ttdeci">bool IsFinBitSet</div><div class="ttdoc">Gets the value of the is fin bit set</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00075">WebSocketFrame.cs:75</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5e1ac0b3b1f528823146cc751402d2c3"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5e1ac0b3b1f528823146cc751402d2c3">Alis.Core.Network.Internal.WebSocketImplementation._readCursor</a></div><div class="ttdeci">WebSocketReadCursor _readCursor</div><div class="ttdoc">The read cursor</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00120">WebSocketImplementation.cs:120</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer_html_a9e4fba02f2c935b41897c3e830998bac"><div class="ttname"><a href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html#a9e4fba02f2c935b41897c3e830998bac">Alis.Core.Network.Internal.WebSocketFrameWriter.Write</a></div><div class="ttdeci">static void Write(WebSocketOpCode opCode, ArraySegment&lt; byte &gt; fromPayload, MemoryStream toStream, bool isLastFrame, bool isClient)</div><div class="ttdoc">No async await stuff here because we are dealing with a memory stream</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dd3/_web_socket_frame_writer_8cs_source.html#l00065">WebSocketFrameWriter.cs:65</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html_a23e45b8a75d2dc83a4d2f678685f6c55"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html#a23e45b8a75d2dc83a4d2f678685f6c55">Alis.Core.Network.Internal.WebSocketFrame.OpCode</a></div><div class="ttdeci">WebSocketOpCode OpCode</div><div class="ttdoc">Gets the value of the op code</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00080">WebSocketFrame.cs:80</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a792e8711385348448f343ac7fab704de"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a792e8711385348448f343ac7fab704de">Alis.Core.Network.Internal.Events.CloseOutputAutoTimeoutError</a></div><div class="ttdeci">void CloseOutputAutoTimeoutError(Guid guid, string closeException, WebSocketCloseStatus closeStatus, string statusDescription, string exception)</div><div class="ttdoc">Closes the output auto timeout error using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00406">Events.cs:406</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_aee180aa952fafd7d45f69792f48b90c4"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#aee180aa952fafd7d45f69792f48b90c4">Alis.Core.Network.Internal.Events.KeepAliveIntervalZero</a></div><div class="ttdeci">void KeepAliveIntervalZero(Guid guid)</div><div class="ttdoc">Keeps the alive interval zero using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00312">Events.cs:312</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a57ca1eb8d26b8263c587e9e264820f39"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a57ca1eb8d26b8263c587e9e264820f39">Alis.Core.Network.Internal.Events.TryGetBufferNotSupported</a></div><div class="ttdeci">void TryGetBufferNotSupported(Guid guid, string streamType)</div><div class="ttdoc">Tries the get buffer not supported using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00422">Events.cs:422</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_ping_pong_manager_html"><div class="ttname"><a href="../../da/d5f/class_alis_1_1_core_1_1_network_1_1_ping_pong_manager.html">Alis.Core.Network.PingPongManager</a></div><div class="ttdoc">Ping Pong Manager used to facilitate ping pong WebSocket messages</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/de6/_ping_pong_manager_8cs_source.html#l00042">PingPongManager.cs:43</a></div></div>
<div class="ttc" id="anamespace_alis_1_1_core_1_1_network_1_1_internal_html_a97c05b66f5a680048c0dd10c4890ceae"><div class="ttname"><a href="../../df/dd2/namespace_alis_1_1_core_1_1_network_1_1_internal.html#a97c05b66f5a680048c0dd10c4890ceae">Alis.Core.Network.Internal.WebSocketOpCode</a></div><div class="ttdeci">WebSocketOpCode</div><div class="ttdoc">The web socket op code enum</div><div class="ttdef"><b>Definition:</b> <a href="../../db/df5/_web_socket_op_code_8cs_source.html#l00035">WebSocketOpCode.cs:36</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_af9d1a2b079e9216e1821ac1053f776ed"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af9d1a2b079e9216e1821ac1053f776ed">Alis.Core.Network.Internal.WebSocketImplementation.OnPong</a></div><div class="ttdeci">virtual void OnPong(PongEventArgs e)</div><div class="ttdoc">Called when a Pong frame is received</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00510">WebSocketImplementation.cs:510</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_afab6be1a75087a1817471656cfb1023f"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#afab6be1a75087a1817471656cfb1023f">Alis.Core.Network.Internal.WebSocketImplementation._isContinuationFrame</a></div><div class="ttdeci">bool _isContinuationFrame</div><div class="ttdoc">The is continuation frame</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00115">WebSocketImplementation.cs:115</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a3f3c85f8f4f325a614bc99dcbde1a537"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a3f3c85f8f4f325a614bc99dcbde1a537">Alis.Core.Network.Internal.Events.InvalidStateBeforeCloseOutput</a></div><div class="ttdeci">void InvalidStateBeforeCloseOutput(Guid guid, WebSocketState webSocketState)</div><div class="ttdoc">Invalids the state before close output using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00606">Events.cs:606</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a185c9c824ff614c93a7f83efe06d3cfc"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a185c9c824ff614c93a7f83efe06d3cfc">Alis.Core.Network.Internal.WebSocketImplementation._internalReadCts</a></div><div class="ttdeci">readonly CancellationTokenSource _internalReadCts</div><div class="ttdoc">The internal read cts</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00065">WebSocketImplementation.cs:65</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_html"><div class="ttname"><a href="../../d8/dc1/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame.html">Alis.Core.Network.Internal.WebSocketFrame</a></div><div class="ttdoc">The web socket frame class</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/_web_socket_frame_8cs_source.html#l00038">WebSocketFrame.cs:39</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a1aa5bf101aa734ccb4184b035a969f2e"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a1aa5bf101aa734ccb4184b035a969f2e">Alis.Core.Network.Internal.WebSocketImplementation._closeStatus</a></div><div class="ttdeci">WebSocketCloseStatus? _closeStatus</div><div class="ttdoc">The close status</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00100">WebSocketImplementation.cs:100</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a763109aeafa8f5e6e2b6897ff0eb6b3d"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a763109aeafa8f5e6e2b6897ff0eb6b3d">Alis.Core.Network.Internal.WebSocketImplementation.State</a></div><div class="ttdeci">override WebSocketState State</div><div class="ttdoc">Gets the value of the state</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00197">WebSocketImplementation.cs:197</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_abe46a9580b6a3dd2855e19783f9f2efc"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#abe46a9580b6a3dd2855e19783f9f2efc">Alis.Core.Network.Internal.Events.CloseOutputAutoTimeoutCancelled</a></div><div class="ttdeci">void CloseOutputAutoTimeoutCancelled(Guid guid, int timeoutSeconds, WebSocketCloseStatus closeStatus, string statusDescription, string exception)</div><div class="ttdoc">Closes the output auto timeout cancelled using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00387">Events.cs:387</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer_html"><div class="ttname"><a href="../../dd/dc0/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_writer.html">Alis.Core.Network.Internal.WebSocketFrameWriter</a></div><div class="ttdoc">The web socket frame writer class</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/dd3/_web_socket_frame_writer_8cs_source.html#l00044">WebSocketFrameWriter.cs:45</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5baa8ffbc69eb4c4724c0ae272459cbc"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5baa8ffbc69eb4c4724c0ae272459cbc">Alis.Core.Network.Internal.WebSocketImplementation._isClient</a></div><div class="ttdeci">readonly bool _isClient</div><div class="ttdoc">The is client</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00070">WebSocketImplementation.cs:70</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a84c2deca93283a8eb514ef28c543d8e8"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a84c2deca93283a8eb514ef28c543d8e8">Alis.Core.Network.Internal.WebSocketImplementation.SendAsync</a></div><div class="ttdeci">override async Task SendAsync(ArraySegment&lt; byte &gt; buffer, WebSocketMessageType messageType, bool endOfMessage, CancellationToken cancellationToken)</div><div class="ttdoc">Send data to the web socket</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00354">WebSocketImplementation.cs:354</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a782a73e4f8f4875e50670bfac4d2e5ad"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a782a73e4f8f4875e50670bfac4d2e5ad">Alis.Core.Network.Internal.Events.WebSocketDisposeCloseTimeout</a></div><div class="ttdeci">void WebSocketDisposeCloseTimeout(Guid guid, WebSocketState webSocketState)</div><div class="ttdoc">Webs the socket dispose close timeout using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00563">Events.cs:563</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5f8d53537efa6b9c79df94fa84d8b3be"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5f8d53537efa6b9c79df94fa84d8b3be">Alis.Core.Network.Internal.WebSocketImplementation._usePerMessageDeflate</a></div><div class="ttdeci">readonly bool _usePerMessageDeflate</div><div class="ttdoc">The use per message deflate</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00095">WebSocketImplementation.cs:95</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5a72b7fc11e35dccfee1874f3619fc73"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5a72b7fc11e35dccfee1874f3619fc73">Alis.Core.Network.Internal.WebSocketImplementation._continuationFrameMessageType</a></div><div class="ttdeci">WebSocketMessageType _continuationFrameMessageType</div><div class="ttdoc">The binary</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00110">WebSocketImplementation.cs:110</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor_html_a6974574a8bc92f1114c4a22c84a69bcd"><div class="ttname"><a href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a6974574a8bc92f1114c4a22c84a69bcd">Alis.Core.Network.Internal.WebSocketReadCursor.NumBytesLeftToRead</a></div><div class="ttdeci">int NumBytesLeftToRead</div><div class="ttdoc">Gets the value of the num bytes left to read</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d0a/_web_socket_read_cursor_8cs_source.html#l00065">WebSocketReadCursor.cs:65</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_af2c27569ac1004f4e881ef221029b683"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#af2c27569ac1004f4e881ef221029b683">Alis.Core.Network.Internal.WebSocketImplementation.CloseStatus</a></div><div class="ttdeci">override? WebSocketCloseStatus CloseStatus</div><div class="ttdoc">Gets the value of the close status</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00187">WebSocketImplementation.cs:187</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a5b164ade1c7448160bb4ff8d376af394"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a5b164ade1c7448160bb4ff8d376af394">Alis.Core.Network.Internal.WebSocketImplementation.BuildClosePayload</a></div><div class="ttdeci">ArraySegment&lt; byte &gt; BuildClosePayload(WebSocketCloseStatus closeStatus, string statusDescription)</div><div class="ttdoc">As per the spec, write the close status followed by the close reason</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00521">WebSocketImplementation.cs:521</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader_html_af33409b62a797e4aa9ef9118a47f6b4e"><div class="ttname"><a href="../../de/d96/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_frame_reader.html#af33409b62a797e4aa9ef9118a47f6b4e">Alis.Core.Network.Internal.WebSocketFrameReader.ReadAsync</a></div><div class="ttdeci">static async Task&lt; WebSocketReadCursor &gt; ReadAsync(Stream fromStream, ArraySegment&lt; byte &gt; intoBuffer, CancellationToken cancellationToken)</div><div class="ttdoc">Read a WebSocket frame from the stream</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d06/_web_socket_frame_reader_8cs_source.html#l00095">WebSocketFrameReader.cs:95</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_events_html_a07194615353187017f499e95b427d1bf"><div class="ttname"><a href="../../de/d69/class_alis_1_1_core_1_1_network_1_1_internal_1_1_events.html#a07194615353187017f499e95b427d1bf">Alis.Core.Network.Internal.Events.CloseHandshakeComplete</a></div><div class="ttdeci">void CloseHandshakeComplete(Guid guid)</div><div class="ttdoc">Closes the handshake complete using the specified guid</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d19/_events_8cs_source.html#l00517">Events.cs:517</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_abb1d1f6e107c83687f28eafe9738249b"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#abb1d1f6e107c83687f28eafe9738249b">Alis.Core.Network.Internal.WebSocketImplementation._stream</a></div><div class="ttdeci">readonly Stream _stream</div><div class="ttdoc">The stream</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00090">WebSocketImplementation.cs:90</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a130c0dd79df32564fbf4e8d175f7e62e"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a130c0dd79df32564fbf4e8d175f7e62e">Alis.Core.Network.Internal.WebSocketImplementation._semaphore</a></div><div class="ttdeci">readonly SemaphoreSlim _semaphore</div><div class="ttdoc">The semaphore slim</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00085">WebSocketImplementation.cs:85</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a977ee8b322d9590c8b58fbeb1cda70c8"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a977ee8b322d9590c8b58fbeb1cda70c8">Alis.Core.Network.Internal.WebSocketImplementation.GetOppCode</a></div><div class="ttdeci">WebSocketOpCode GetOppCode(WebSocketMessageType messageType)</div><div class="ttdoc">Turns a spec websocket frame opcode into a WebSocketMessageType</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00682">WebSocketImplementation.cs:682</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor_html_a40149f29d1ef97e3f01770ad38312cdc"><div class="ttname"><a href="../../dd/df8/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_read_cursor.html#a40149f29d1ef97e3f01770ad38312cdc">Alis.Core.Network.Internal.WebSocketReadCursor.WebSocketFrame</a></div><div class="ttdeci">WebSocketFrame WebSocketFrame</div><div class="ttdoc">Gets the value of the web socket frame</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d0a/_web_socket_read_cursor_8cs_source.html#l00053">WebSocketReadCursor.cs:53</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_a0971f376ca0011d325c291dbbd26b90f"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#a0971f376ca0011d325c291dbbd26b90f">Alis.Core.Network.Internal.WebSocketImplementation.CloseAsync</a></div><div class="ttdeci">override async Task CloseAsync(WebSocketCloseStatus closeStatus, string statusDescription, CancellationToken cancellationToken)</div><div class="ttdoc">Polite close (use the close handshake)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00422">WebSocketImplementation.cs:422</a></div></div>
<div class="ttc" id="aclass_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation_html_adf2e6e658f53ec1e3605592fe3045597"><div class="ttname"><a href="../../da/d64/class_alis_1_1_core_1_1_network_1_1_internal_1_1_web_socket_implementation.html#adf2e6e658f53ec1e3605592fe3045597">Alis.Core.Network.Internal.WebSocketImplementation.CloseOutputAutoTimeoutAsync</a></div><div class="ttdeci">async Task CloseOutputAutoTimeoutAsync(WebSocketCloseStatus closeStatus, string statusDescription, Exception ex)</div><div class="ttdoc">Automatic WebSocket close in response to some invalid data from the remote websocket host</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d8e/_web_socket_implementation_8cs_source.html#l00709">WebSocketImplementation.cs:709</a></div></div>

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_8272ea2c9ef4a5a450abbc74ffafe4de.html">4_Operation</a></li><li class="navelem"><a class="el" href="../../dir_f2d230172fe1011c12300d92ec0aef26.html">Network</a></li><li class="navelem"><a class="el" href="../../dir_98a892797ab166238a7e6f53fc17c979.html">src</a></li><li class="navelem"><a class="el" href="../../dir_df58ff48fc06b4a346bfd317f3bbb299.html">Internal</a></li><li class="navelem"><b>WebSocketImplementation.cs</b></li>
    <li class="footer">
      <a>Generated on | Tue Apr 4 2023 |</a>
    </li>
  </ul>
</div>
</body>
</html>
